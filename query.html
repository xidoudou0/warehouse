<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>仓库物资查询系统</title>
    <style>
        body {
            font-family: "Microsoft YaHei", Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .search-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        #keyword {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        #search-btn {
            padding: 12px 25px;
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
        }
        #search-btn:hover {
            background-color: #3367d6;
        }
        #result-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        #result-table th, #result-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: center;
        }
        #result-table th {
            background-color: #f0f0f0;
            font-weight: bold;
            color: #555;
        }
        #result-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .empty-message {
            color: #777;
            text-align: center;
            padding: 30px;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>仓库物资库存查询</h1>
        <div class="search-bar">
            <input type="text" id="keyword" placeholder="请输入物资编码或描述（例如：001 或 电源）">
            <button id="search-btn" onclick="search()">查询</button>
        </div>
        <table id="result-table"></table>
    </div>

    <script>
        let inventoryData = [];
        // 替换为你的 inventory.csv Raw 链接
        const csvUrl = "https://raw.githubusercontent.com/xidoudou0/warehouse/main/inventory.csv";

        window.onload = function() {
            loadCsvData();
        };

        function loadCsvData() {
            fetch(csvUrl)
                .then(response => {
                    if (!response.ok) throw new Error("数据加载失败，请检查CSV链接");
                    return response.text();
                })
                .then(csvText => {
                    inventoryData = parseCsv(csvText); // 使用优化后的解析函数
                })
                .catch(error => {
                    document.getElementById("result-table").innerHTML = 
                        `<tr><td class="empty-message" colspan="4">${error.message}</td></tr>`;
                });
        }

        // 【优化】解析含逗号、双引号的CSV（符合RFC4180标准）
        function parseCsv(csvText) {
            const lines = [];
            let currentLine = [];
            let currentField = '';
            let inQuotes = false; // 是否在双引号内

            // 逐字符解析（处理换行、逗号、双引号）
            for (let i = 0; i < csvText.length; i++) {
                const char = csvText[i];
                const nextChar = csvText[i + 1];

                // 处理双引号
                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        // 连续双引号视为单个双引号（例如"" → "）
                        currentField += '"';
                        i++; // 跳过下一个双引号
                    } else {
                        inQuotes = !inQuotes; // 切换引号状态
                    }
                } 
                // 处理逗号（仅当不在引号内时，视为分隔符）
                else if (char === ',' && !inQuotes) {
                    currentLine.push(currentField.trim()); // 字段加入当前行
                    currentField = ''; // 重置字段
                } 
                // 处理换行（仅当不在引号内时，视为行结束）
                else if ((char === '\n' || char === '\r') && !inQuotes) {
                    if (currentField !== '' || currentLine.length > 0) {
                        currentLine.push(currentField.trim());
                        lines.push(currentLine); // 行加入结果
                        currentLine = []; // 重置行
                        currentField = ''; // 重置字段
                    }
                    // 跳过可能的\r\n组合
                    if (char === '\r' && nextChar === '\n') i++;
                } 
                // 普通字符直接加入字段
                else {
                    currentField += char;
                }
            }

            // 处理最后一行
            if (currentField !== '' || currentLine.length > 0) {
                currentLine.push(currentField.trim());
                lines.push(currentLine);
            }

            // 验证数据格式
            if (lines.length === 0) throw new Error("CSV文件为空");
            const headers = lines[0];
            const requiredHeaders = ['物资编码', '物资描述', '数量', '货架号'];
            const missingHeaders = requiredHeaders.filter(h => !headers.includes(h));
            if (missingHeaders.length > 0) {
                throw new Error(`缺失字段：${missingHeaders.join('、')}`);
            }

            // 转换为对象数组
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                const item = {};
                headers.forEach((header, index) => {
                    item[header] = lines[i][index] || '';
                });
                data.push(item);
            }
            return data;
        }

        function search() {
            const keyword = document.getElementById("keyword").value.trim().toLowerCase();
            const resultTable = document.getElementById("result-table");
            resultTable.innerHTML = '';

            if (!keyword) {
                resultTable.innerHTML = `<tr><td class="empty-message" colspan="4">请输入查询内容</td></tr>`;
                return;
            }

            const matchedResults = inventoryData.filter(item => {
                const codeMatch = item['物资编码'].toLowerCase() === keyword;
                const descMatch = item['物资描述'].toLowerCase().includes(keyword);
                return codeMatch || descMatch;
            });

            if (matchedResults.length === 0) {
                resultTable.innerHTML = `<tr><td class="empty-message" colspan="4">未找到匹配物资</td></tr>`;
                return;
            }

            // 表头顺序：物资编码 → 物资描述 → 数量 → 货架号
            const headerOrder = ['物资编码', '物资描述', '数量', '货架号'];
            let tableHtml = '<tr>';
            headerOrder.forEach(header => tableHtml += `<th>${header}</th>`);
            tableHtml += '</tr>';

            matchedResults.forEach(item => {
                tableHtml += '<tr>';
                headerOrder.forEach(header => tableHtml += `<td>${item[header]}</td>`);
                tableHtml += '</tr>';
            });

            resultTable.innerHTML = tableHtml;
        }

        // 支持回车键查询
        document.getElementById("keyword").addEventListener('keypress', e => {
            if (e.key === 'Enter') search();
        });
    </script>
</body>
</html>